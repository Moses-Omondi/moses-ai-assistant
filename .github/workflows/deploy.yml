name: ğŸš€ Deploy Moses AI Assistant to AWS Lambda

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: ğŸš€ Deploy to AWS Lambda
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ”§ Install AWS SAM CLI
      uses: aws-actions/setup-sam@v2
      
    - name: ğŸ”‘ Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: ğŸ—ï¸ Build Lambda Package
      run: sam build --use-container
      
    - name: ğŸš€ Deploy to AWS
      id: deploy
      run: |
        sam deploy \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset \
          --stack-name moses-ai-assistant \
          --parameter-overrides Stage=prod \
          --capabilities CAPABILITY_IAM \
          --region ${{ env.AWS_REGION }}
        
        # Get API URL
        API_URL=$(aws cloudformation describe-stacks \
          --stack-name moses-ai-assistant \
          --query 'Stacks[0].Outputs[?OutputKey==`MosesAIAssistantApi`].OutputValue' \
          --output text \
          --region ${{ env.AWS_REGION }})
        
        echo "api_url=$API_URL" >> $GITHUB_OUTPUT
        echo "ğŸ”— Your AI Assistant is live at: $API_URL"
        
    - name: ğŸ§ª Test API
      run: |
        echo "â³ Waiting for Lambda to initialize..."
        sleep 30
        
        API_URL="${{ steps.deploy.outputs.api_url }}"
        
        if curl -f -s "$API_URL" > /dev/null; then
          echo "âœ… API is responding successfully!"
          echo "ğŸ‰ Your Moses AI Assistant is live and ready!"
        else
          echo "âš ï¸ API deployment completed but may need a moment to warm up"
        fi
        
        echo ""
        echo "ğŸ“‹ Your AI Assistant Details:"
        echo "ğŸ”— API URL: $API_URL"
        echo "ğŸ“± Test with: curl $API_URL"
        echo "ğŸ’¬ Query endpoint: $API_URL/query"
        echo "ğŸ’° Cost: ~\$0.05-5/month (pay per request)"
